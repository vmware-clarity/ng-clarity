<!--
~ Copyright (c) 2016-2025 Broadcom. All Rights Reserved.
~ The term "Broadcom" refers to Broadcom Inc. and/or its subsidiaries.
~ This software is released under MIT license.
~ The full license information can be found in LICENSE in the root directory of this project.
-->

<!-- The (click) handler is needed to auto-focus on input field which can not currently occupy the whole
width of the component, after being wrapped to a new line -->
<div
  #wrapper
  class="clr-combobox-wrapper"
  clrPopoverAnchor
  (click)="onWrapperClick($event)"
  [class.multi]="multiSelect"
  [class.invalid]="invalid"
  [class.disabled]="control?.disabled? true: null"
>
  @if (multiSelect && multiSelectModel && multiSelectModel.length > 0) {
  <span
    role="grid"
    clrRovingTabindex
    [clrRovingTabindexDisabled]="control?.disabled"
    clrDirection="both"
    [attr.aria-label]="getSelectionAriaLabel()"
    [attr.aria-disabled]="control?.disabled? true: null"
    class="clr-combobox-pills"
  >
    @if (isTotalSelection) {
    <span class="label label-combobox-pill" role="row">
      <span role="gridcell">
        <span class="clr-combobox-pill-content" clrKeyFocusItem> All {{ multiSelectModel.length }} selected </span>
      </span>
      <span role="gridcell">
        <button
          clrKeyFocusItem
          type="button"
          class="clr-combobox-remove-btn"
          (click)="clearSelection()"
          [attr.aria-label]="commonStrings.keys.comboboxUnselectAll"
        >
          <cds-icon shape="window-close" size="12"></cds-icon>
        </button>
      </span>
    </span>
    } @else { @for (item of multiSelectModel | slice:0:visibleLimit; track item; let i = $index) {
    <span class="label label-combobox-pill" role="row">
      <span role="gridcell">
        <span class="clr-combobox-pill-content" clrKeyFocusItem>
          @if (optionSelected) {
          <ng-container
            [ngTemplateOutlet]="optionSelected.template"
            [ngTemplateOutletContext]="{$implicit: item}"
          ></ng-container>
          }
        </span>
      </span>
      <span role="gridcell">
        <button
          clrKeyFocusItem
          type="button"
          class="clr-combobox-remove-btn"
          [disabled]="control?.disabled? true: null"
          [attr.aria-label]="commonStrings.keys.comboboxDelete + ' ' + optionSelectionService.selectionModel.toString(displayField, i)"
          (click)="unselect(item)"
        >
          <cds-icon shape="window-close" size="12"></cds-icon>
        </button>
      </span>
    </span>
    } @if (calculatedLimit !== null && calculatedLimit < multiSelectModel.length) {
    <span role="row" class="label label-combobox-pill clr-combobox-truncation-row">
      <span role="gridcell" class="clr-combobox-truncation-cell">
        <span class="clr-combobox-pill-content">
          <button
            #truncationButton
            clrKeyFocusItem
            type="button"
            class="btn btn-link clr-combobox-show-more-btn"
            (click)="toggleSelectionExpand()"
            [attr.aria-expanded]="selectionExpanded"
            [attr.aria-controls]="'expanded-selection-' + id"
          >
            @if (!selectionExpanded) { {{showAllText}} } @else { {{commonStrings.keys.comboboxShowLess}} }
          </button>
        </span>
      </span>
    </span>
    } }
  </span>

  @if (shouldCalculate && !isTotalSelection) {
  <span class="clr-combobox-pills-calculation" aria-hidden="true">
    @for (item of multiSelectModel; track item; let i = $index) {
    <span class="label label-combobox-pill" #pill>
      <span class="clr-combobox-pill-content">
        @if (optionSelected) {
        <ng-container
          [ngTemplateOutlet]="optionSelected.template"
          [ngTemplateOutletContext]="{$implicit: item}"
        ></ng-container>
        }
      </span>
      <button type="button" class="clr-combobox-remove-btn" tabindex="-1">
        <cds-icon shape="window-close" size="12"></cds-icon>
      </button>
    </span>
    }
  </span>
  } }

  <input
    #textboxInput
    type="text"
    role="combobox"
    [id]="inputId()"
    class="clr-input clr-combobox-input"
    [(ngModel)]="searchText"
    (blur)="onBlur($event)"
    (focus)="onFocus()"
    (change)="onChange()"
    [attr.aria-expanded]="openState"
    [attr.aria-owns]="ariaOwns"
    aria-haspopup="listbox"
    aria-autocomplete="list"
    autocomplete="off"
    [attr.aria-invalid]="control?.invalid? true: null"
    [disabled]="control?.disabled? true: null"
    [attr.aria-activedescendant]="getActiveDescendant()"
    [attr.placeholder]="placeholder"
  />

  <!-- No click handler, as it uses the handler on the .clr-combobox-wrapper -->
  <button
    #trigger
    type="button"
    class="clr-combobox-trigger"
    tabindex="-1"
    [disabled]="control?.disabled || null"
    [attr.aria-label]="commonStrings.keys.comboboxOpen"
  >
    <cds-icon shape="angle" direction="down"></cds-icon>
  </button>

  <div class="clr-focus-indicator" [class.clr-focus]="focused"></div>
</div>

<!-- Both close handlers are handled manually due to issues in Edge browser.
Additionally 'outsideClickToClose' has complex handling that's necessary
to be manual due to the component architecture -->
<div role="dialog" *clrPopoverContent="openState; at popoverPosition; type: popoverType;">
  <ng-content></ng-content>
</div>
